#!/usr/bin/env node

// exprimental result
//
//  Rules of icc v2 profile generated by macos
//
//   - PCSIlluminant value of header always has fixed value
//       <XYZNumber X="0.964202880859" Y="1.000000000000" Z="0.824905395508" />
//
//   - The mediaWhitePoint tag always has a normalized value of the display's
//     native white point.
//
//   - The colorant tag always has a value of the native chromaticity adapted
//     from mediaWhitePoint to PCIlluminant.
//     A bradford matrix is ​​used for chromatic adaptation.
//
//   -- The generated tone response curve closely matches the Display P3's
//      parametric curve.  However, so far it has not been able to create
//      an exact match formula.
//
//   As a prediction, macOS may determine whether it is a D50 adaptive color
//   gamut or a display native color gamut based on the sum of colorant tags
//   in the case of v2 profile.
//

const fs = require('node:fs/promises'),
  path = require('node:path'),
  math = require('mathjs'),
  IccMaxDOM = require('../lib/iccmax-dom'),
  fp = require('../lib/fp'),
  { toS15F16UInt32, fromS15F16UInt32 } = require('../lib/fp'),
  { decode_ndin } = require('../lib/icc-private-tags'),
  {
    xyzChromaticity,
    chromaticAdaptBradford,
    createLut,
    createMacDefaultLut
  } = require('../lib/display-icc'),
  CIE_D50_WHITE = [0.96422, 1, 0.82521],
  r = (v) => fromS15F16UInt32(toS15F16UInt32(v))

async function display_p3() {
  const icc_xml_file = path.join(__dirname, '..', 'data', 'Display P3.xml'),
    icc = await IccMaxDOM.fromXmlFile(icc_xml_file)
  return {
    pcs_w: icc.selectHeader().PCSIlluminant,
    chromaticity: icc.selectDisplayChromaticity(),
    chad: icc.selectChromaticAdaption(),
    trc: icc.selectToneResponseCurve('r')
  }
}

async function simulate(file, p3) {
  const icc_xml_file = path.join(__dirname, '..', 'data', file),
    icc = await IccMaxDOM.fromXmlFile(icc_xml_file),
    ndin = decode_ndin(icc.selectPrivateTagData('ndin'), true),
    pcs_w = icc.selectHeader().PCSIlluminant,
    native_chromaticity = xyzChromaticity(ndin),
    // to S15Fixed16Number Signed-Integer
    target_chromaticity = icc.selectDisplayChromaticity(),
    target_chromaticity_int = fp.toS15F16Int32(target_chromaticity),
    chromaticity_tests = [],
    chromaticity_test = (test, fn) => {
      const c = fn(native_chromaticity),
        rc = fp.toS15F16Int32(c) // to S15Fixed16Number Signed-Integer
      chromaticity_tests.push({
        test,
        c,
        diff: {
          w: math.subtract(rc.w, target_chromaticity_int.w),
          r: math.subtract(rc.r, target_chromaticity_int.r),
          g: math.subtract(rc.g, target_chromaticity_int.g),
          b: math.subtract(rc.b, target_chromaticity_int.b)
        },
        rgbsum: math.add(c.r, c.g, c.b)
      })
    },
    target_trc = icc.selectToneResponseCurve('r'),
    trc_tests = [],
    trc_test = (test, fn) => {
      const trc = fn()
      trc_tests.push({
        test,
        diff_points: math
          .subtract(trc, target_trc)
          .map((d, i) => ({ i, d }))
          .filter((p) => p.d !== 0)
          .map((p) => ({ i: p.i, x: p.i / 0x3ff, d: p.d }))
      })
    }

  chromaticity_test('Bradford + native white -> CIE D50', (n) =>
    chromaticAdaptBradford(n, CIE_D50_WHITE)
  )

  chromaticity_test('Bradford + native white -> Display P3 D50', (n) =>
    chromaticAdaptBradford(n, p3.chromaticity.w)
  )
  chromaticity_test('Bradford + native white -> Display P3 PCS White', (n) =>
    chromaticAdaptBradford(n, p3.pcs_w)
  )
  chromaticity_test('Display P3 D65 -> D50 Transform', (n) => ({
    w: math.multiply(p3.chad, n.w),
    r: math.multiply(p3.chad, n.r),
    g: math.multiply(p3.chad, n.g),
    b: math.multiply(p3.chad, n.b)
  }))

  trc_test('Display P3 Parametric Curve', () => createLut(p3.trc))

  trc_test('Fine-Tuned Parametric Curve', () => createMacDefaultLut())

  return {
    file,
    native_chromaticity,
    target_chromaticity: {
      pcs_w,
      ...target_chromaticity,
      rgbsum: math.add(target_chromaticity.r, target_chromaticity.g, target_chromaticity.b)
    },
    chromaticity_tests,
    trc_tests
  }
}

async function main() {
  const test_files = [
      'aw3225qf_macos_icc.xml',
      's3221qs_macos_icc.xml',
      'mba_m2_lcd_macos_icc.xml'
    ],
    p3 = await display_p3(),
    results = await Promise.all(test_files.map(async (f) => await simulate(f, p3)))
  console.log(JSON.stringify(results, null, 2))
}

main()
  .catch((err) => {
    console.error(err)
    process.exit(1)
  })
  .then(() => {})
